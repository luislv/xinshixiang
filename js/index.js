require(["chicken/public/js/public","widget/lazyLoad/lazyLoadImg","chicken/public/js/playerR","widget/scrollBottom/scrollBottom","widget/slider/slider-Touch-by-transform"],function(e,a,t,n,i){function s(e,a){player.autoPlayTriggerFirst(),x=!1,$(e).addClass("loading"),$.ajax({url:"/chicken/item/get_available_item_info",type:"post",data:{item_id:a,__s:p.source},dataType:"json",success:function(a){if(0==a.code){if(!h.commonEmpty(a.result.item_info)){var t=a.result.item_info;player.submitProgressInterval=a.result.submit_progress_interval,w=[t],$(".btn-listen").addClass("hide"),player.updateSourcesList(w,!0),x=!0,player.showPlayerView()}}else h.commonHackAlert(a.message.text);$(e).removeClass("loading")},error:function(a){h.commonHandleAjaxError(a),$(e).removeClass("loading")}})}function o(){clearInterval(I),I=setInterval(function(){var e=l(S);e.seconds<=0&&e.minutes<=0&&e.hours<=0&&e.days<=0&&(clearInterval(I),I=null),$(".block-daily-new .hours").html(e.hours),$(".block-daily-new .minutes").html(e.minutes),$(".block-daily-new .seconds").html(e.seconds)},1e3)}function l(e){var a=864e5,t=36e5,n=6e4,i=1e3,s={},o=+new Date,l=e-o,d=0;return l>=0&&(s.days=parseInt(l/a),d=l%a,s.hours=parseInt(d/t),d%=t,s.minutes=parseInt(d/n),d%=n,s.seconds=parseInt(d/i)),r(s)}function r(e){for(var a in e)e[a]<10&&(e[a]="0"+e[a]);return e}function d(e){P=e,$(".daily-new-dialog-container .title").html("获取"+e.title),$(".daily-new-dialog-container .price").html(e.price),$(".daily-new-dialog-container").addClass("show")}function c(){$(".daily-new-dialog-container").removeClass("show")}function m(e){$(".loading-more-tips").show(),$.ajax({url:"/chicken/item/get_onsell_item_list",type:"post",data:e,dataType:"json",success:function(e){0===parseInt(e.code)?(e.result.last_item_id?D.last_item_id=e.result.last_item_id:D=null,u(e.result.item_list)):alert(e.message.text),$(".loading-more-tips").hide(),A.changeFlag()},error:function(e){h.commonHandleAjaxError(e),$(".loading-more-tips").hide(),A.changeFlag()}})}function u(e){if(e instanceof Array&&e.length>0){for(var a=0;a<e.length;a++){var t=e[a],n=p.renderItemListHandleBtnTpl(t),i='<div class="book-item needsclick item-type-'+t.item_type+'" data-price="'+t.price+'" data-item_type="'+t.item_type+'"  data-item_id="'+t.item_id+'" data-sku="'+t.sku_list[0].sku_no+'"><div class="date-box"><span class="date">'+t.start_time.text+"</span>"+("play"===t.status?'<span class="readed">已听'+t.attachment.progress_rate+"%</span>":"")+'</div><div class="book-info"><a class="book-img" href="'+t.url+'"><img class="lazy-img" data-url="'+t.cover_img.url+'"></a><div class="book-intro"><a class="book-name" href="'+t.url+'">'+t.item_name+'</a><a class="book-desc" href="'+t.url+'">'+t.desc+'</a><div class="duration"><span class="duration-text">时长:'+t.attachment.duration.text+"</span>"+n+"</div></div></div></div>";$(".listen-history-list").append(i)}k.refresh()}}var h=e.common,p=e,g=a,_=t,f=n,b=i,v=0,y=$(".hidden-nick-value").val(),k=new g({threshold:100,urlName:"data-url",imgSelector:".lazy-img"}),C=(new b("banner-slider",{autoPlay:!0}),{});$(".banner-box .banner-item").on("touchstart",function(e){C.s_x=e.changedTouches[0].pageX}),$(".banner-box .banner-item").on("touchend",function(e){C.e_x=e.changedTouches[0].pageX,Math.abs(C.e_x-C.s_x)<10&&(window.location.href=$(this).attr("href"))}),p.setShareOptions({link:location.href}),window.player=new _({autoShow:!1,displayViewType:"normal",miniViewBottom:49,videoJsSet:{preload:"metadata",autoplay:!1},currentSourceIndex:0,continuePlay:!0,miniCloseCallback:function(){},playerViewTypeChangeCallback:function(e){if("normal"===e){var a={title:y+"邀请你来听"+this.currentSource.item_name+" | 新世相读书会",desc:this.currentSource.desc,shareTimelineDesc:y+"邀请你来听"+this.currentSource.item_name+" | 新世相读书会",link:location.origin+"/chicken/page/listen_detail?item_id="+this.currentSource.item_id+(p.source?"&__s="+p.source:"")},t=this.currentSource.promos,n=!1,i=null;if(t&&t instanceof Array)for(var s=0;s<t.length;s++)if("award_1_gift_x"===t[s].rule_label&&t[s].ext_info&&t[s].ext_info.gift_left_num>0){i=t[s],n=!0;break}n&&(a={title:y+"请5个人免费听"+this.currentSource.item_name+" | 新世相读书会",desc:this.currentSource.desc,image:this.currentSource.cover_img.url,shareTimelineDesc:y+"请5个人免费听"+this.currentSource.item_name+" | 新世相读书会",link:location.origin+"/chicken/activity/share_book?item_id="+this.currentSource.item_id+"&hashid="+i.ext_info.hashid}),p.setShareOptions(a)}else p.setShareOptions({link:location.href})}});var w=[],x=!0;$(document).on("click",".book-item .handle-play-btn",function(e){e.stopPropagation(),e.preventDefault();var a=$(this).parents(".book-item"),t=a.attr("data-item_id"),n=a.attr("data-item_type");v=t,"audio_item"===n?x&&!$(this).hasClass("loading")&&s(this,t):"article_item"===n&&p.pageJump("/chicken/page/reader?item_id="+t)}),$(document).on("click",".free-item .play-btn",function(e){e.stopPropagation(),e.preventDefault();var a=$(this).attr("data-item_id");v=a,x&&!$(this).hasClass("loading")&&s(this,a)}),$(document).on("click",".book-item .handle-reserve-btn",function(e){e.stopPropagation(),e.preventDefault();var a=this;if(!$(a).hasClass("reserved")){var t=$(this).parents(".book-item"),n=t.attr("data-item_id"),i=t.attr("data-sku");p.dialogReserveMobileSetting({data:{item_id:n,sku_no:i},success:function(e){0==e.code&&$(a).addClass("reserved").html("已预约")},error:function(e){}}),$(this).hasClass("reserved")||$(".dialog-reserve-mobile").show()}}),$(document).on("click",".book-item .handle-buy-btn",function(e){e.stopPropagation(),e.preventDefault(),"pass"===$(this).attr("data-btn_status")&&Thefair.addEventGa("chicken_index","click","get_forfree_tap");var a=$(this).parents(".book-item"),t=(a.find(".book-name").text(),a.find(".book-img img").attr("src"),a.attr("data-item_id")),n=a.attr("data-item_type"),i=(a.attr("data-price"),a.attr("data-sku")),s=$(this).attr("data-method"),o=this;$(o).hasClass("loading")||$(o).hasClass("payed")||($(o).addClass("loading"),p.callPayment({displayCheckDialog:"direct"!==s,paymentInfo:{params:{item_id:t,sku_no:i,__s:p.source},success:function(e){$(o).addClass("payed"),$(o).removeClass("handle-buy-btn").addClass("handle-play-btn").html("audio_item"===n?"播放":"开始阅读")},fail:function(e){},finish:function(e){$(".handle-btn.loading").removeClass("loading")}},cancelPayment:function(){$(".handle-buy-btn.loading").removeClass("loading")}}))}),$(document).on("click",".block-daily-new .book-item",function(e){var a=this,t=$(a).attr("href");if(e.stopPropagation(),e.preventDefault(),0===$(a).find(".handle-get-btn-1").length){if(!($(e.target).hasClass("handle-play-btn")||$(e.target).parents(".handle-play-btn").length>0||$(e.target).hasClass("handle-read-btn")||$(e.target).parents(".handle-read-btn").length>0))return window.location.href=t,!1}else d({title:$(a).find(".book-name>span").text(),price:$(a).find(".price").text(),item_id:$(a).attr("data-item_id"),item_type:$(a).attr("data-item_type"),sku_no:$(a).attr("data-sku"),dom:a})});var T=new Date,S=+new Date(T.getFullYear()+"/"+(T.getMonth()+1)+"/"+T.getDate()+" 23:59:59"),I=null;o(),$(".daily-new-dialog-container").off("click").click(function(e){$(e.target).hasClass("daily-new-dialog-container")&&$(this).removeClass("show")});var P=null;if($(".daily-new-dialog-container .share-btn").click(function(e){var a=this;$(a).hasClass("loading")||(Thefair.addEventGa("Page_index","click","getfree_click"),$(a).addClass("loading"),$.ajax({url:"/chicken/activity/free",type:"post",data:{item_id:P.item_id,__s:p.source},dataType:"json",success:function(e){0===parseInt(e.code)?("new"===e.result.status?($(a).removeClass("loading"),p.pageJump("/chicken/activity/giward_share?item_id="+P.item_id)):"success"===e.result.status?"audio_item"===P.item_type?$(P.dom).find(".handle-get-btn-1").removeClass("handle-get-btn-1").addClass("handle-play-btn").html('<span class="btn-text">播放</span>'):"article_item"===P.item_type?$(P.dom).find(".handle-get-btn-1").removeClass("handle-get-btn-1").addClass("handle-read-btn").html('<span class="btn-text">开始阅读</span>'):$(P.dom).find(".handle-get-btn-1").remove():h.commonHackAlert(e.result.status),c(),$(a).removeClass("loading")):(h.commonHackAlert(e.message.text),$(a).removeClass("loading"))},error:function(e){h.commonHandleAjaxError(e),$(a).removeClass("loading")}}))}),$(".daily-new-dialog-container .buy-btn").click(function(e){var a=this;if(!$(a).hasClass("loading")&&!$(a).hasClass("payed")){Thefair.addEventGa("Page_index","click","getfree_buy"),$(a).addClass("loading");var t={item_id:P.item_id,sku_no:P.sku_no,__s:p.source};$.ajax({url:"/chicken/pay/direct_pay",type:"post",data:t,dataType:"json",success:function(e){if(0==e.code){var t=e.result.sign;console.log(t),e.result.need_pay?p.chooseWXPay({signInfo:t,callback:function(e){switch(e){case"success":p.showToast("success","支付成功"),$(a).addClass("payed"),"audio_item"===P.item_type?$(P.dom).find(".handle-get-btn-1").removeClass("handle-get-btn-1").addClass("handle-play-btn").html('<span class="btn-text">播放</span>'):"article_item"===P.item_type?$(P.dom).find(".handle-get-btn-1").removeClass("handle-get-btn-1").addClass("handle-read-btn").html('<span class="btn-text">开始阅读</span>'):$(P.dom).find(".handle-get-btn-1").remove();break;case"fail":p.showToast("fail","支付失败");break;case"cancel":p.showToast("fail","支付取消")}},outTradeNo:e.result.out_trade_no}):(p.showToast("success","领取成功"),"audio_item"===P.item_type?$(P.dom).find(".handle-get-btn-1").removeClass("handle-get-btn-1").addClass("handle-play-btn").html('<span class="btn-text">播放</span>'):"article_item"===P.item_type?$(P.dom).find(".handle-get-btn-1").removeClass("handle-get-btn-1").addClass("handle-read-btn").html('<span class="btn-text">开始阅读</span>'):$(P.dom).find(".handle-get-btn-1").remove()),c()}else h.commonHackAlert(e.message.text);$(a).removeClass("loading")},error:function(e){h.commonHandleAjaxError(e),$(a).removeClass("loading")}})}}),$(".pass-box").click(function(){Thefair.addEventGa("chicken_index","click","purchase_button_of_home_tap")}),Thefair.parseUA().android&&"activated"===p.passStatus){var j=$.getCookie("android_download_index_dialog_1");j||($(".app-download-dialog").show(),$.setCookie("android_download_index_dialog_1",1,7,"/"))}var D=$(".hidden-page_params-value").val()?JSON.parse($(".hidden-page_params-value").val()):null,A=new f({triggerLen:500,callback:function(){D?m(D):A.changeFlag()}})});